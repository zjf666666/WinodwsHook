# Windows Security Guard 系统架构图

## 完整分层架构

```
┌────────────────────────────────────────────────────────────┐
│                    应用层 (SecurityGuardUI)                 │
│              MFC界面 | 用户交互 | 配置管理                    │
├────────────────────────────────────────────────────────────┤
│                   服务层 (SecurityService)                  │
│           命名管道服务 | 消息分发 | 客户端会话管理               │
├────────────────────────────────────────────────────────────┤
│                    业务层 (ProtectionModules)               │
│            文件保护 | 进程保护 | 注册表保护 | 网络监控           │
├────────────────────────────────────────────────────────────┤
│                    核心层 (SecurityCore + HookEngine)       │
│              Hook引擎 | 进程注入 | PE解析 | 指令重定位          │
├────────────────────────────────────────────────────────────┤
│                      公共组件层                              │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │   Logger    │ │ EventBus    │ │ ThreadPool  │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │MemoryMgr    │ │    IPC      │ │ConfigMgr    │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
├────────────────────────────────────────────────────────────┤
│                     基础工具类层                             │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │StringUtils  │ │ FileUtils   │ │ProcessUtils │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │RegistryUtils│ │SystemUtils  │ │CryptoUtils  │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
├────────────────────────────────────────────────────────────┤
│                    系统API层 (Windows API)                  │
└────────────────────────────────────────────────────────────┘
```

## 模块间通信关系

```
┌─────────────────┐    命名管道通信    ┌─────────────────┐
│ SecurityGuardUI │ ◄──────────────► │ SecurityService │
└─────────────────┘                  └─────────────────┘
                                              │
                                              │ 消息分发
                                              ▼
┌─────────────────┐    Hook事件通知   ┌─────────────────┐
│   HookEngine    │ ◄──────────────► │ProtectionModules│
└─────────────────┘                  └─────────────────┘
         │                                    │
         │                                    │
         └────────────► SecurityCore ◄────────┘
                      (基础工具支持)
```

## 各层职责说明

### 应用层 (SecurityGuardUI)
- **职责**: 用户界面展示和交互
- **组件**: MFC对话框、控件管理、用户输入处理
- **通信**: 通过命名管道与SecurityService通信

### 服务层 (SecurityService)
- **职责**: 系统服务、进程间通信、消息路由
- **核心组件**:
  - `NamedPipeServer`: 命名管道服务器
  - `MessageDispatcher`: 消息分发器
  - `ClientSession`: 客户端会话管理
- **通信**: 
  - 上层: 接收UI层的控制指令
  - 下层: 调用业务层和核心层功能

### 业务层 (ProtectionModules)
- **职责**: 具体的安全防护业务逻辑
- **模块**: 文件保护、进程保护、注册表保护、网络监控
- **依赖**: 依赖HookEngine提供的Hook能力

### 核心层 (SecurityCore + HookEngine)
- **SecurityCore职责**: 
  - 系统工具类 (ProcessUtils, MemoryUtils等)
  - PE文件解析 (PEHeaderParse)
  - 进程注入管理 (ProcessInjectionManager)
- **HookEngine职责**:
  - Hook技术实现 (InlineHook, IATHook)
  - 指令解析和重定位 (InstructionParser, InstructionRelocator)
  - Hook生命周期管理

### 公共组件层
- **Logger**: 统一日志系统
- **EventBus**: 事件总线 (待实现)
- **ThreadPool**: 线程池 (待实现)
- **MemoryMgr**: 内存管理器 (待实现)
- **IPC**: 进程间通信抽象
- **ConfigMgr**: 配置管理器

### 基础工具类层
- **StringUtils**: 字符串处理工具
- **FileUtils**: 文件操作工具 (待实现)
- **ProcessUtils**: 进程操作工具
- **RegistryUtils**: 注册表操作工具 (待实现)
- **SystemUtils**: 系统信息工具 (待实现)
- **CryptoUtils**: 加密工具 (OpenSSLUtils)

## 数据流向

```
用户操作 → SecurityGuardUI → 命名管道 → SecurityService 
    ↓
消息分发 → ProtectionModules → HookEngine → 系统API
    ↓
Hook事件 → 事件处理 → 日志记录 → 结果返回
```

## 技术特点

1. **分层解耦**: 每层职责明确，降低耦合度
2. **服务化架构**: SecurityService作为核心服务层，统一管理业务逻辑
3. **事件驱动**: Hook事件驱动的异步处理机制
4. **模块化设计**: 支持功能模块的独立开发和部署
5. **可扩展性**: 清晰的接口定义，便于功能扩展

## 当前实现状态

### ✅ 已实现
- SecurityGuardUI (基础框架)
- SecurityService (完整实现)
- SecurityCore (核心工具类)
- HookEngine (基础Hook技术)
- 基础工具类 (部分实现)

- ProtectionModules (框架搭建)
- ConfigManager (基础框架)

### ❌ 待实现
- 完整的业务防护逻辑
- 事件总线系统
- 线程池管理
- 高级Hook技术